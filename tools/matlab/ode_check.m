close all
clear
clc

%% ../../input/engine/AeroTech_J450DM.eng

time = [0.   , 0.012, 0.018, 0.024, 0.033, 0.062, 0.121, 0.263, 0.453,...
       0.527, 0.627, 0.701, 0.787, 0.802, 0.834, 0.941, 1.047, 1.083,...
       1.142, 1.293, 1.396, 1.494, 1.633, 1.666, 1.725, 1.814, 1.899,...
       1.97 , 2.03 , 2.071, 2.089, 2.133, 2.169, 2.21 , 2.249, 2.266,...
       2.311];
   
thrust = [  0.   , 270.708, 356.898, 392.102, 377.535, 371.465, 413.953,...
       449.157, 467.367, 492.859, 501.357, 504.999, 509.854, 541.417,...
       526.85 , 528.064, 541.417, 532.919, 537.775, 537.775, 519.566,...
       520.78 , 512.282, 495.287, 491.645, 474.65 , 455.227, 439.446,...
       437.018, 433.376, 415.167, 356.898, 267.067, 179.663,  88.618,...
        41.274,   0.   ];

mass = [1.223     , 1.2222197 , 1.22131518, 1.2202357 , 1.21857187,...
       1.21335439, 1.20222342, 1.17278361, 1.13095456, 1.11388644,...
       1.09000496, 1.07211687, 1.05115249, 1.0473647 , 1.03915343,...
       1.01204019, 0.98480945, 0.97551929, 0.96034537, 0.92133428,...
       0.89517458, 0.87068483, 0.83619256, 0.82820583, 0.81421899,...
       0.79356137, 0.77457574, 0.75931755, 0.74668573, 0.73811377,...
       0.73444494, 0.726285  , 0.72088936, 0.71648979, 0.71397655,...
       0.71344614, 0.713     ];
   
global fThrust fMass

method  = 'pchip';

fThrust = griddedInterpolant(time, thrust, method, 'nearest');
fMass   = griddedInterpolant(time, mass  , method, 'nearest');

%%

% WGS 84 Constants
gamE = 9.7803253359;        % [m/s^2]
k    = 1.931852652458e-03;  % [-]
e    = 8.1819190842622e-02; % [-]
a    = 6378137.0;           % [m]
f    = 3.3528106647475e-03; % [-]
m    = 3.449786506841e-03;  % [-]

lat = 32.2698;
lat = lat*pi/180;

sin2phi = sin(lat)^2;
e2      = e^2;
gam     = gamE * (1 + k*sin2phi) / sqrt(1 - e2*sin2phi);
a2      = a^2;

global fGrav

fGrav = @(h) gam * (1 - (2/a)*(1 + f + m - 2*f*sin2phi)*h + (3/a2)*h^2);

%%

global massBody launchFlag

massBody   = 5;
launchFlag = true;

t  = 0 : 0.01 : 36;
y0 = [0, 0];

opts = odeset('RelTol',1e-9,'AbsTol',1e-9);

[t,x] = ode45( @ode_fun, t, y0, opts);

pos = x(:,1);
vel = x(:,2);

iGnd = intersect(find(pos <=0), find(vel < 0));
iGnd = iGnd(1);

apogee = max(pos)
gnd    = pos(iGnd)

